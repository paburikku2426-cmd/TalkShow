<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TalkShow</title>

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #fafafa;
    }
    #result {
      padding: 10px;
      background: #fff;
      border-radius: 6px;
      margin-top: 20px;
      min-height: 80px;
      border: 1px solid #ddd;
      font-size: 1.2rem;
      line-height: 1.8;
    }
    button {
      font-size: 1.1rem;
      padding: 10px 16px;
      margin-right: 8px;
    }
  </style>
</head>

<body>

  <h1>TalkShow テスト</h1>
  <button id="startBtn">▶ 音声認識スタート</button>
  <button id="stopBtn">■ 停止</button>

  <div id="result">（認識した内容がひらがなで表示されます）</div>

  <!-- Kuromoji.js 読み込み（パスはあなたの環境に合わせてね） -->
  <script src="kuromoji.js"></script>

  <script>
    let tokenizer = null;

    // ------------------------------
    // ① Kuromoji の初期化
    // ------------------------------
    function initKuromoji() {
      return new Promise((resolve, reject) => {
        kuromoji.builder({ dicPath: "dict" }).build((err, builtTokenizer) => {
          if (err) {
            reject(err);
            return;
          }
          tokenizer = builtTokenizer;
          resolve();
        });
      });
    }

    // ------------------------------
    // ② 文章 → ひらがな変換
    // ------------------------------
    function toHiragana(text) {
      if (!tokenizer) return text;

      const tokens = tokenizer.tokenize(text);
      return tokens
        .map(t => {
          // 読みがない場合はそのまま
          if (!t.reading) return t.surface_form;

          // 読みはカタカナなのでひらがなに変換
          return t.reading.replace(/[\u30A1-\u30F6]/g, ch =>
            String.fromCharCode(ch.charCodeAt(0) - 0x60)
          );
        })
        .join("");
    }

    // ------------------------------
    // ③ Web Speech API 設定
    // ------------------------------
    const SpeechRecognition =
      window.SpeechRecognition || window.webkitSpeechRecognition;

    const recognition = new SpeechRecognition();
    recognition.lang = "ja-JP";
    recognition.interimResults = true;
    recognition.continuous = true;

    const resultDiv = document.getElementById("result");

    recognition.onresult = event => {
      let text = "";

      for (let i = 0; i < event.results.length; i++) {
        text += event.results[i][0].transcript;
      }

      const hira = tokenizer ? toHiragana(text) : "(辞書読み込み中...) " + text;
      resultDiv.textContent = hira;
    };

    recognition.onerror = e => {
      console.error("SpeechRecognition error:", e);
    };

    // ------------------------------
    // ④ ボタン
    // ------------------------------
    document.getElementById("startBtn").onclick = () => {
      recognition.start();
    };
    document.getElementById("stopBtn").onclick = () => {
      recognition.stop();
    };

    // ------------------------------
    // ⑤ 初期化実行
    // ------------------------------
    initKuromoji()
      .then(() => console.log("Kuromoji Ready"))
      .catch(err => console.error("Kuromoji Error:", err));
  </script>
</body>
</html>
